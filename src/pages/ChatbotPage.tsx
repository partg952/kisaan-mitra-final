import { useState, useRef, useEffect } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import { MessageCircle, Send, Bot, User, Loader2, MapPin, Globe, AlertCircle, Mic, MicOff } from "lucide-react";
import { chatbotApi, ChatbotApiError } from "@/services/chatbotApi";

// Extend Window interface for speech recognition
declare global {
  interface Window {
    SpeechRecognition: any;
    webkitSpeechRecognition: any;
  }
}

interface Message {
  id: string;
  content: string;
  role: "user" | "assistant";
  timestamp: Date;
}

interface Location {
  latitude: number;
  longitude: number;
  name?: string;
}

const LANGUAGE_OPTIONS = [
  { value: "en", label: "English", flag: "ЁЯЗ║ЁЯЗ╕", speechCode: "en-US" },
  { value: "hi", label: "рд╣рд┐рдиреНрджреА (Hindi)", flag: "ЁЯЗоЁЯЗ│", speechCode: "hi-IN" },
  { value: "bn", label: "ржмрж╛ржВрж▓рж╛ (Bengali)", flag: "ЁЯЗзЁЯЗй", speechCode: "bn-BD" },
  { value: "te", label: "р░др▒Жр░▓р▒Бр░Чр▒Б (Telugu)", flag: "ЁЯЗоЁЯЗ│", speechCode: "te-IN" },
  { value: "ta", label: "родрооро┐ро┤рпН (Tamil)", flag: "ЁЯЗоЁЯЗ│", speechCode: "ta-IN" },
  { value: "mr", label: "рдорд░рд╛рдареА (Marathi)", flag: "ЁЯЗоЁЯЗ│", speechCode: "mr-IN" },
  { value: "gu", label: "ркЧрлБркЬрк░рк╛ркдрлА (Gujarati)", flag: "ЁЯЗоЁЯЗ│", speechCode: "gu-IN" },
];

const ChatbotPage = () => {
  const [messages, setMessages] = useState<Message[]>([]);
  const [inputMessage, setInputMessage] = useState("");
  const [isLoading, setIsLoading] = useState(false);
  const [location, setLocation] = useState<Location>({
    latitude: 28.6139,
    longitude: 77.2090,
    name: "Delhi"
  });
  const [selectedLanguage, setSelectedLanguage] = useState("en");
  const [locationStatus, setLocationStatus] = useState<"idle" | "loading" | "success" | "error">("idle");
  const [apiStatus, setApiStatus] = useState<"unknown" | "online" | "offline">("unknown");
  const [isListening, setIsListening] = useState(false);
  const [speechSupported, setSpeechSupported] = useState(false);
  const scrollAreaRef = useRef<HTMLDivElement>(null);
  const recognitionRef = useRef<any>(null);

  // Multilingual messages for speech recognition
  const getMultilingualMessages = () => {
    const messages = {
      en: {
        listening: "Listening... Speak now",
        clickToSpeak: "Click to speak",
        stopListening: "Stop listening",
        voiceEnabled: "Voice enabled",
        noSpeech: "No speech detected. Please try again.",
        noMicrophone: "No microphone found. Please check your microphone.",
        permissionDenied: "Microphone permission denied. Please allow microphone access.",
        speechError: "Speech recognition error. Please try again.",
        placeholder: "Ask about crops, soil, weather, or farming techniques...",
        voiceInstructions: "You can also use the microphone button to speak your questions.",
        pressEnter: "Press Enter to send",
        listeningStatus: "ЁЯОд Listening...",
        voiceEnabledStatus: "Voice enabled",
        apiOnline: "API Online",
        apiOffline: "API Offline",
        checkingApi: "Checking API..."
      },
      hi: {
        listening: "рд╕реБрди рд░рд╣рд╛ рд╣реВрдВ... рдЕрдм рдмреЛрд▓рд┐рдП",
        clickToSpeak: "рдмреЛрд▓рдиреЗ рдХреЗ рд▓рд┐рдП рдХреНрд▓рд┐рдХ рдХрд░реЗрдВ",
        stopListening: "рд╕реБрдирдирд╛ рдмрдВрдж рдХрд░реЗрдВ",
        voiceEnabled: "рдЖрд╡рд╛рдЬрд╝ рд╕рдХреНрд╖рдо",
        noSpeech: "рдХреЛрдИ рдЖрд╡рд╛рдЬрд╝ рдирд╣реАрдВ рдорд┐рд▓реАред рдХреГрдкрдпрд╛ рдлрд┐рд░ рд╕реЗ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВред",
        noMicrophone: "рдорд╛рдЗрдХреНрд░реЛрдлрд╝реЛрди рдирд╣реАрдВ рдорд┐рд▓рд╛ред рдХреГрдкрдпрд╛ рдЕрдкрдирд╛ рдорд╛рдЗрдХреНрд░реЛрдлрд╝реЛрди рдЬрд╛рдВрдЪреЗрдВред",
        permissionDenied: "рдорд╛рдЗрдХреНрд░реЛрдлрд╝реЛрди рдХреА рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рджреА рдЧрдИред рдХреГрдкрдпрд╛ рдорд╛рдЗрдХреНрд░реЛрдлрд╝реЛрди рдХреА рдкрд╣реБрдВрдЪ рджреЗрдВред",
        speechError: "рдЖрд╡рд╛рдЬрд╝ рдкрд╣рдЪрд╛рди рддреНрд░реБрдЯрд┐ред рдХреГрдкрдпрд╛ рдлрд┐рд░ рд╕реЗ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВред",
        placeholder: "рдлрд╕рд▓, рдорд┐рдЯреНрдЯреА, рдореМрд╕рдо рдпрд╛ рдХреГрд╖рд┐ рддрдХрдиреАрдХреЛрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдкреВрдЫреЗрдВ...",
        voiceInstructions: "рдЖрдк рдЕрдкрдиреЗ рд╕рд╡рд╛рд▓ рдмреЛрд▓рдиреЗ рдХреЗ рд▓рд┐рдП рдорд╛рдЗрдХреНрд░реЛрдлрд╝реЛрди рдмрдЯрди рдХрд╛ рднреА рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред",
        pressEnter: "рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдВрдЯрд░ рджрдмрд╛рдПрдВ",
        listeningStatus: "ЁЯОд рд╕реБрди рд░рд╣рд╛ рд╣реИ...",
        voiceEnabledStatus: "рдЖрд╡рд╛рдЬрд╝ рд╕рдХреНрд╖рдо",
        apiOnline: "рдПрдкреАрдЖрдИ рдСрдирд▓рд╛рдЗрди",
        apiOffline: "рдПрдкреАрдЖрдИ рдСрдлрд▓рд╛рдЗрди",
        checkingApi: "рдПрдкреАрдЖрдИ рдЬрд╛рдВрдЪ рд░рд╣рд╛ рд╣реИ..."
      },
      bn: {
        listening: "рж╢рзБржиржЫрж┐... ржПржЦржи ржмрж▓рзБржи",
        clickToSpeak: "ржмрж▓рж╛рж░ ржЬржирзНржп ржХрзНрж▓рж┐ржХ ржХрж░рзБржи",
        stopListening: "рж╢рзЛржирж╛ ржмржирзНржз ржХрж░рзБржи",
        voiceEnabled: "ржХржгрзНржарж╕рзНржмрж░ рж╕ржХрзНрж╖ржо",
        noSpeech: "ржХрзЛржирзЛ ржХржерж╛ рж╢ржирж╛ржХрзНржд рж╣ржпрж╝ржирж┐ред ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ ржЖржмрж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рзБржиред",
        noMicrophone: "ржорж╛ржЗржХрзНрж░рзЛржлрзЛржи ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ржирж┐ред ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ ржЖржкржирж╛рж░ ржорж╛ржЗржХрзНрж░рзЛржлрзЛржи ржкрж░рзАржХрзНрж╖рж╛ ржХрж░рзБржиред",
        permissionDenied: "ржорж╛ржЗржХрзНрж░рзЛржлрзЛржирзЗрж░ ржЕржирзБржорждрж┐ ржирзЗржЗред ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ ржорж╛ржЗржХрзНрж░рзЛржлрзЛржи ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕ ржжрж┐ржиред",
        speechError: "ржХржерж╛ ржЪрзЗржирж╛рж░ рждрзНрж░рзБржЯрж┐ред ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ ржЖржмрж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рзБржиред",
        placeholder: "ржлрж╕рж▓, ржорж╛ржЯрж┐, ржЖржмрж╣рж╛ржУржпрж╝рж╛ ржмрж╛ ржХрзГрж╖рж┐ ржХрзМрж╢рж▓ рж╕ржорзНржкрж░рзНржХрзЗ ржЬрж┐ржЬрзНржЮрж╛рж╕рж╛ ржХрж░рзБржи...",
        voiceInstructions: "ржЖржкржирж┐ ржЖржкржирж╛рж░ ржкрзНрж░рж╢рзНржи ржмрж▓рж╛рж░ ржЬржирзНржп ржорж╛ржЗржХрзНрж░рзЛржлрзЛржи ржмрзЛрждрж╛ржоржУ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рждрзЗ ржкрж╛рж░рзЗржиред",
        pressEnter: "ржкрж╛ржарж╛рждрзЗ ржПржирзНржЯрж╛рж░ ржЯрж┐ржкрзБржи",
        listeningStatus: "ЁЯОд рж╢рзБржиржЫрж┐...",
        voiceEnabledStatus: "ржХржгрзНржарж╕рзНржмрж░ рж╕ржХрзНрж╖ржо",
        apiOnline: "ржПржкрж┐ржЖржЗ ржЕржирж▓рж╛ржЗржи",
        apiOffline: "ржПржкрж┐ржЖржЗ ржЕржлрж▓рж╛ржЗржи",
        checkingApi: "ржПржкрж┐ржЖржЗ ржкрж░рзАржХрзНрж╖рж╛ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ..."
      },
      te: {
        listening: "р░╡р░┐р░Вр░Яр▒Бр░ир▒Нр░ир░╛р░ир▒Б... р░Зр░кр▒Нр░кр▒Бр░бр▒Б р░ор░╛р░Яр▒Нр░▓р░╛р░бр░Вр░бр░┐",
        clickToSpeak: "р░ор░╛р░Яр▒Нр░▓р░╛р░бр░бр░╛р░ир░┐р░Хр░┐ р░Хр▒Нр░▓р░┐р░Хр▒Н р░Ър▒Зр░пр░Вр░бр░┐",
        stopListening: "р░╡р░┐р░ир░бр░В р░Жр░кр▒Б",
        voiceEnabled: "р░╡р░╛р░пр░┐р░╕р▒Н р░кр▒Нр░░р░╛р░░р░Вр░нр░┐р░Вр░Ър░мр░бр░┐р░Вр░жр░┐",
        noSpeech: "р░ор░╛р░Я р░Чр▒Бр░░р▒Нр░др░┐р░Вр░Ър░мр░бр░▓р▒Зр░жр▒Б. р░жр░пр░Ър▒Зр░╕р░┐ р░ор░│р▒Нр░▓р▒А р░кр▒Нр░░р░пр░др▒Нр░ир░┐р░Вр░Ър░Вр░бр░┐.",
        noMicrophone: "р░ор▒Ир░Хр▒Нр░░р▒Лр░лр▒Лр░ир▒Н р░Хр░ир▒Бр░Чр▒Кр░ир░мр░бр░▓р▒Зр░жр▒Б. р░жр░пр░Ър▒Зр░╕р░┐ р░ор▒А р░ор▒Ир░Хр▒Нр░░р▒Лр░лр▒Лр░ир▒НтАМр░ир░┐ р░др░ир░┐р░Цр▒А р░Ър▒Зр░пр░Вр░бр░┐.",
        permissionDenied: "р░ор▒Ир░Хр▒Нр░░р▒Лр░лр▒Лр░ир▒Н р░Ер░ир▒Бр░ор░др░┐ р░ир░┐р░░р░╛р░Хр░░р░┐р░Вр░Ър░мр░бр░┐р░Вр░жр░┐. р░жр░пр░Ър▒Зр░╕р░┐ р░ор▒Ир░Хр▒Нр░░р▒Лр░лр▒Лр░ир▒Н р░пр░╛р░Хр▒Нр░╕р▒Жр░╕р▒Н р░Ер░ир▒Бр░ор░др░┐р░Вр░Ър░Вр░бр░┐.",
        speechError: "р░ор░╛р░Я р░Чр▒Бр░░р▒Нр░др░┐р░Вр░кр▒Б р░▓р▒Лр░кр░В. р░жр░пр░Ър▒Зр░╕р░┐ р░ор░│р▒Нр░▓р▒А р░кр▒Нр░░р░пр░др▒Нр░ир░┐р░Вр░Ър░Вр░бр░┐.",
        placeholder: "р░кр░Вр░Яр░▓р▒Б, р░ор░Яр▒Нр░Яр░┐, р░╡р░╛р░др░╛р░╡р░░р░гр░В р░▓р▒Зр░жр░╛ р░╡р▒Нр░пр░╡р░╕р░╛р░п р░╕р░╛р░Вр░Хр▒Зр░др░┐р░Хр░др░▓ р░Чр▒Бр░░р░┐р░Вр░Ър░┐ р░Ер░бр░Чр░Вр░бр░┐...",
        voiceInstructions: "р░ор▒Ар░░р▒Б р░ор▒А р░кр▒Нр░░р░╢р▒Нр░ир░▓р░ир▒Б р░Ър▒Жр░кр▒Нр░кр░бр░╛р░ир░┐р░Хр░┐ р░ор▒Ир░Хр▒Нр░░р▒Лр░лр▒Лр░ир▒Н р░мр░Яр░ир▒НтАМр░ир▒Б р░Хр▒Вр░бр░╛ р░Йр░кр░пр▒Лр░Чр░┐р░Вр░Ър░╡р░Ър▒Нр░Ър▒Б.",
        pressEnter: "р░Ер░пр░┐р░╖р▒Нр░Яр░╛р░ир░┐р░Хр░┐ р░Ор░Вр░Яр░░р▒Н р░жр░мр░╛р░Вр░бр░┐",
        listeningStatus: "ЁЯОд р░╡р░┐р░Вр░Яр▒Бр░ир▒Нр░ир░╛р░ир▒Б...",
        voiceEnabledStatus: "р░╡р░╛р░пр░┐р░╕р▒Н р░кр▒Нр░░р░╛р░░р░Вр░нр░┐р░Вр░Ър░мр░бр░┐р░Вр░жр░┐",
        apiOnline: "р░Рр░кр▒Ар░Жр░пр░┐ р░Жр░ир▒НтАМр░▓р▒Ир░ир▒Н",
        apiOffline: "р░Рр░кр▒Ар░Жр░пр░┐ р░Жр░лр▒НтАМр░▓р▒Ир░ир▒Н",
        checkingApi: "р░Рр░кр▒Ар░Жр░пр░┐ р░др░ир░┐р░Цр▒А р░Ър▒Зр░╕р▒Нр░др▒Бр░ир▒Нр░ир░╛р░ор▒Б..."
      },
      ta: {
        listening: "роХрпЗроЯрпНроХро┐ро▒рпЗройрпН... роЗрокрпНрокрпЛродрпБ рокрпЗроЪрпБроЩрпНроХро│рпН",
        clickToSpeak: "рокрпЗроЪ роХро┐ро│ро┐роХрпН роЪрпЖропрпНропро╡рпБроорпН",
        stopListening: "роХрпЗроЯрпНрокродрпИ роиро┐ро▒рпБродрпНродрпБ",
        voiceEnabled: "роХрпБро░ро▓рпН роЪрпЖропро▓рпНрокроЯрпБродрпНродрокрпНрокроЯрпНроЯродрпБ",
        noSpeech: "рокрпЗроЪрпНроЪрпБ роХрогрпНроЯро▒ро┐ропрокрпНрокроЯро╡ро┐ро▓рпНро▓рпИ. родропро╡рпБроЪрпЖропрпНродрпБ роорпАрогрпНроЯрпБроорпН роорпБропро▒рпНроЪро┐роХрпНроХро╡рпБроорпН.",
        noMicrophone: "роорпИроХрпНро░рпЛроГрокрпЛройрпН роХро┐роЯрпИроХрпНроХро╡ро┐ро▓рпНро▓рпИ. роЙроЩрпНроХро│рпН роорпИроХрпНро░рпЛроГрокрпЛройрпИроЪрпН роЪро░ро┐рокро╛ро░рпНроХрпНроХро╡рпБроорпН.",
        permissionDenied: "роорпИроХрпНро░рпЛроГрокрпЛройрпН роЕройрпБроородро┐ рооро▒рпБроХрпНроХрокрпНрокроЯрпНроЯродрпБ. роорпИроХрпНро░рпЛроГрокрпЛройрпН роЕрогрпБроХро▓рпИ роЕройрпБроородро┐роХрпНроХро╡рпБроорпН.",
        speechError: "рокрпЗроЪрпНроЪрпБ роЕроЩрпНроХрпАроХро╛ро░ рокро┐ро┤рпИ. родропро╡рпБроЪрпЖропрпНродрпБ роорпАрогрпНроЯрпБроорпН роорпБропро▒рпНроЪро┐роХрпНроХро╡рпБроорпН.",
        placeholder: "рокропро┐ро░рпНроХро│рпН, роорогрпН, ро╡ро╛ройро┐ро▓рпИ роЕро▓рпНро▓родрпБ ро╡рпЗро│ро╛рогрпН роирпБроЯрпНрокроЩрпНроХро│рпИрокрпН рокро▒рпНро▒ро┐ роХрпЗро│рпБроЩрпНроХро│рпН...",
        voiceInstructions: "роЙроЩрпНроХро│рпН роХрпЗро│рпНро╡ро┐роХро│рпИроЪрпН роЪрпКро▓рпНро▓ роорпИроХрпНро░рпЗро╛роГрокрпЛройрпН рокрпКродрпНродро╛ройрпИропрпБроорпН рокропройрпНрокроЯрпБродрпНродро▓ро╛роорпН.",
        pressEnter: "роЕройрпБрокрпНрок роОройрпНроЯро░рпН роЕро┤рпБродрпНродро╡рпБроорпН",
        listeningStatus: "ЁЯОд роХрпЗроЯрпНроХро┐ро▒рпЗройрпН...",
        voiceEnabledStatus: "роХрпБро░ро▓рпН роЪрпЖропро▓рпНрокроЯрпБродрпНродрокрпНрокроЯрпНроЯродрпБ",
        apiOnline: "роПрокро┐роЖропро┐ роЖройрпНро▓рпИройрпН",
        apiOffline: "роПрокро┐роЖропро┐ роЖрокрпНро▓рпИройрпН",
        checkingApi: "роПрокро┐роЖропро┐ роЪро░ро┐рокро╛ро░рпНроХрпНроХро┐ро▒родрпБ..."
      },
      mr: {
        listening: "рдРрдХрдд рдЖрд╣реЗ... рдЖрддрд╛ рдмреЛрд▓рд╛",
        clickToSpeak: "рдмреЛрд▓рдгреНрдпрд╛рд╕рд╛рдареА рдХреНрд▓рд┐рдХ рдХрд░рд╛",
        stopListening: "рдРрдХрдгреЗ рдерд╛рдВрдмрд╡рд╛",
        voiceEnabled: "рдЖрд╡рд╛рдЬ рд╕рдХреНрд╖рдо",
        noSpeech: "рдХреЛрдгрддреЗрд╣реА рднрд╛рд╖рдг рдЖрдврд│рд▓реЗ рдирд╛рд╣реА. рдХреГрдкрдпрд╛ рдкреБрдиреНрд╣рд╛ рдкреНрд░рдпрддреНрди рдХрд░рд╛.",
        noMicrophone: "рдорд╛рдпрдХреНрд░реЛрдлреЛрди рд╕рд╛рдкрдбрд▓рд╛ рдирд╛рд╣реА. рдХреГрдкрдпрд╛ рддреБрдордЪрд╛ рдорд╛рдпрдХреНрд░реЛрдлреЛрди рддрдкрд╛рд╕рд╛.",
        permissionDenied: "рдорд╛рдпрдХреНрд░реЛрдлреЛрди рдкрд░рд╡рд╛рдирдЧреА рдирд╛рдХрд╛рд░рд▓реА. рдХреГрдкрдпрд╛ рдорд╛рдпрдХреНрд░реЛрдлреЛрди рдкреНрд░рд╡реЗрд╢рд╛рд╕ рдкрд░рд╡рд╛рдирдЧреА рджреНрдпрд╛.",
        speechError: "рднрд╛рд╖рдг рдУрд│рдЦ рддреНрд░реБрдЯреА. рдХреГрдкрдпрд╛ рдкреБрдиреНрд╣рд╛ рдкреНрд░рдпрддреНрди рдХрд░рд╛.",
        placeholder: "рдкрд┐рдХреЗ, рдорд╛рддреА, рд╣рд╡рд╛рдорд╛рди рдХрд┐рдВрд╡рд╛ рд╢реЗрддреА рддрдВрддреНрд░рд╛рдВрдмрджреНрджрд▓ рд╡рд┐рдЪрд╛рд░рд╛...",
        voiceInstructions: "рддреБрдореНрд╣реА рддреБрдордЪреЗ рдкреНрд░рд╢реНрди рдмреЛрд▓рдгреНрдпрд╛рд╕рд╛рдареА рдорд╛рдпрдХреНрд░реЛрдлреЛрди рдмрдЯрди рджреЗрдЦреАрд▓ рд╡рд╛рдкрд░реВ рд╢рдХрддрд╛.",
        pressEnter: "рдкрд╛рдард╡рдгреНрдпрд╛рд╕рд╛рдареА рдПрдиреНрдЯрд░ рджрд╛рдмрд╛",
        listeningStatus: "ЁЯОд рдРрдХрдд рдЖрд╣реЗ...",
        voiceEnabledStatus: "рдЖрд╡рд╛рдЬ рд╕рдХреНрд╖рдо",
        apiOnline: "рдЖрдпреЗрдкреАрдЖрдп рдСрдирд▓рд╛рдИрди",
        apiOffline: "рдЖрдпреЗрдкреАрдЖрдп рдСрдлрд▓рд╛рдИрди",
        checkingApi: "рдЖрдпреЗрдкреАрдЖрдп рддрдкрд╛рд╕рдд рдЖрд╣реЗ..."
      },
      gu: {
        listening: "рк╕рк╛ркВркнрк│рлА рк░рк╣рлНркпрлЛ ркЫрлБркВ... рк╣рк╡рлЗ ркмрлЛрк▓рлЛ",
        clickToSpeak: "ркмрлЛрк▓рк╡рк╛ ркорк╛ркЯрлЗ ркХрлНрк▓рк┐ркХ ркХрк░рлЛ",
        stopListening: "рк╕рк╛ркВркнрк│рк╡рк╛ркирлБркВ ркмркВркз ркХрк░рлЛ",
        voiceEnabled: "ркЕрк╡рк╛ркЬ рк╕ркХрлНрк╖рко",
        noSpeech: "ркХрлЛркИ рк╡рк╛ркгрлА ркорк│рлА ркиркерлА. ркХрлГрккрк╛ ркХрк░рлАркирлЗ рклрк░рлА рккрлНрк░ркпрк╛рк╕ ркХрк░рлЛ.",
        noMicrophone: "ркорк╛ркЗркХрлНрк░рлЛрклрлЛрки ркорк│рлНркпрлЛ ркиркерлА. ркХрлГрккрк╛ ркХрк░рлАркирлЗ ркдркорк╛рк░рк╛ ркорк╛ркЗркХрлНрк░рлЛрклрлЛркиркирлЗ ркдрккрк╛рк╕рлЛ.",
        permissionDenied: "ркорк╛ркЗркХрлНрк░рлЛрклрлЛрки рккрк░ркорк┐рк╢рки ркиркХрк╛рк░рк╡рк╛ркорк╛ркВ ркЖрк╡рлА. ркХрлГрккрк╛ ркХрк░рлАркирлЗ ркорк╛ркЗркХрлНрк░рлЛрклрлЛрки ркПркХрлНрк╕рлЗрк╕ ркЖрккрлЛ.",
        speechError: "рк╡рк╛ркгрлА ркУрк│ркЦрк╛ркг ркнрлВрк▓. ркХрлГрккрк╛ ркХрк░рлАркирлЗ рклрк░рлА рккрлНрк░ркпрк╛рк╕ ркХрк░рлЛ.",
        placeholder: "рккрк╛ркХ, ркорк╛ркЯрлА, рк╣рк╡рк╛ркорк╛рки ркЕркерк╡рк╛ ркХрлГрк╖рк┐ ркдркХркирлАркХрлЛ рк╡рк┐рк╢рлЗ рккрлВркЫрлЛ...",
        voiceInstructions: "ркдркорлЗ ркдркорк╛рк░рк╛ рккрлНрк░рк╢рлНркирлЛ ркмрлЛрк▓рк╡рк╛ ркорк╛ркЯрлЗ ркорк╛ркЗркХрлНрк░рлЛрклрлЛрки ркмркЯркиркирлЛ рккркг ркЙрккркпрлЛркЧ ркХрк░рлА рк╢ркХрлЛ ркЫрлЛ.",
        pressEnter: "ркорлЛркХрк▓рк╡рк╛ ркорк╛ркЯрлЗ ркПркирлНркЯрк░ ркжркмрк╛рк╡рлЛ",
        listeningStatus: "ЁЯОд рк╕рк╛ркВркнрк│рлА рк░рк╣рлНркпрлЛ ркЫрлБркВ...",
        voiceEnabledStatus: "ркЕрк╡рк╛ркЬ рк╕ркХрлНрк╖рко",
        apiOnline: "ркПрккрлАркЖркЗ ркУркирк▓рк╛ркЗрки",
        apiOffline: "ркПрккрлАркЖркЗ ркУрклрк▓рк╛ркЗрки",
        checkingApi: "ркПрккрлАркЖркЗ ркдрккрк╛рк╕рлА рк░рк╣рлНркпрлЛ ркЫрлЗ..."
      }
    };
    return messages[selectedLanguage as keyof typeof messages] || messages.en;
  };

  // Auto-scroll to bottom when new messages are added
  useEffect(() => {
    if (scrollAreaRef.current) {
      const scrollContainer = scrollAreaRef.current.querySelector('[data-radix-scroll-area-viewport]');
      if (scrollContainer) {
        scrollContainer.scrollTop = scrollContainer.scrollHeight;
      }
    }
  }, [messages]);

  // Initialize speech recognition and get user's location on component mount
  useEffect(() => {
    getCurrentLocation();
    initializeSpeechRecognition();
  }, []);

  // Initialize speech recognition
  const initializeSpeechRecognition = () => {
    if (typeof window !== 'undefined') {
      const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
      
      if (SpeechRecognition) {
        setSpeechSupported(true);
        recognitionRef.current = new SpeechRecognition();
        
        // Configure speech recognition
        recognitionRef.current.continuous = false;
        recognitionRef.current.interimResults = false;
        recognitionRef.current.maxAlternatives = 1;
        
        // Set language based on selected language
        const languageMap: Record<string, string> = {
          en: 'en-US',
          hi: 'hi-IN',
          bn: 'bn-BD',
          te: 'te-IN',
          ta: 'ta-IN',
          mr: 'mr-IN',
          gu: 'gu-IN'
        };
        recognitionRef.current.lang = languageMap[selectedLanguage] || 'en-US';
        
        // Speech recognition event handlers
        recognitionRef.current.onresult = (event: any) => {
          const transcript = event.results[0][0].transcript;
          setInputMessage(transcript);
          setIsListening(false);
        };
        
        recognitionRef.current.onerror = (event: any) => {
          console.error('Speech recognition error:', event.error);
          setIsListening(false);
          
          // Show user-friendly error message based on error type
          let errorMessage = "";
          switch (event.error) {
            case 'no-speech':
              errorMessage = "No speech detected. Please try again.";
              break;
            case 'audio-capture':
              errorMessage = "No microphone found. Please check your microphone.";
              break;
            case 'not-allowed':
              errorMessage = "Microphone permission denied. Please allow microphone access.";
              break;
            default:
              errorMessage = "Speech recognition error. Please try again.";
          }
          
          // You could show this error in a toast or alert if you have a notification system
          console.warn(errorMessage);
        };
        
        recognitionRef.current.onend = () => {
          setIsListening(false);
        };
      } else {
        setSpeechSupported(false);
      }
    }
  };

  // Update speech recognition language when selected language changes
  useEffect(() => {
    if (recognitionRef.current && speechSupported) {
      const languageMap: Record<string, string> = {
        en: 'en-US',
        hi: 'hi-IN',
        bn: 'bn-BD',
        te: 'te-IN',
        ta: 'ta-IN',
        mr: 'mr-IN',
        gu: 'gu-IN'
      };
      recognitionRef.current.lang = languageMap[selectedLanguage] || 'en-US';
    }
  }, [selectedLanguage, speechSupported]);

  // Start/stop speech recognition
  const toggleSpeechRecognition = () => {
    if (!speechSupported || !recognitionRef.current) {
      console.warn('Speech recognition not supported');
      return;
    }
    
    if (isListening) {
      recognitionRef.current.stop();
      setIsListening(false);
    } else {
      setInputMessage(''); // Clear input before starting
      recognitionRef.current.start();
      setIsListening(true);
    }
  };

  const getCurrentLocation = () => {
    if (!navigator.geolocation) {
      setLocationStatus("error");
      return;
    }

    setLocationStatus("loading");
    navigator.geolocation.getCurrentPosition(
      (position) => {
        setLocation({
          latitude: Number(position.coords.latitude.toFixed(4)),
          longitude: Number(position.coords.longitude.toFixed(4)),
          name: "Current Location"
        });
        setLocationStatus("success");
      },
      (error) => {
        console.error("Error getting location:", error);
        setLocationStatus("error");
        // Keep default Delhi location
      },
      {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 300000 // 5 minutes
      }
    );
  };

  const sendMessage = async () => {
    if (!inputMessage.trim() || isLoading) return;

    const userMessage: Message = {
      id: Date.now().toString(),
      content: inputMessage,
      role: "user",
      timestamp: new Date(),
    };

    setMessages(prev => [...prev, userMessage]);
    setInputMessage("");
    setIsLoading(true);

    try {
      const data = await chatbotApi.sendMessage({
        message: inputMessage,
        languageCode: selectedLanguage,
        latitude: location.latitude,
        longitude: location.longitude,
      });

      // Update API status to online since the request succeeded
      if (apiStatus !== "online") {
        setApiStatus("online");
      }
      
      const assistantMessage: Message = {
        id: (Date.now() + 1).toString(),
        content: data.reply || data.message || "Sorry, I couldn't process your request.",
        role: "assistant",
        timestamp: new Date(),
      };

      setMessages(prev => [...prev, assistantMessage]);
    } catch (error) {
      console.error("Error sending message:", error);
      
      // Update API status if it's a connection error
      if (error instanceof ChatbotApiError && !error.status) {
        setApiStatus("offline");
      }
      
      let errorContent = "Sorry, I'm having trouble connecting to the server. Please try again later.";
      
      if (error instanceof ChatbotApiError) {
        errorContent = error.message;
      }
      
      const errorMessage: Message = {
        id: (Date.now() + 1).toString(),
        content: errorContent,
        role: "assistant",
        timestamp: new Date(),
      };
      setMessages(prev => [...prev, errorMessage]);
    } finally {
      setIsLoading(false);
    }
  };

  const handleKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  };

  return (
    <div className="space-y-6">
      <div className="flex items-center gap-3">
        <MessageCircle className="h-8 w-8 text-primary" />
        <div>
          <h1 className="text-3xl font-bold">AI Assistant</h1>
          <p className="text-muted-foreground">Chat with our agricultural AI assistant for farming insights and recommendations</p>
        </div>
      </div>

      <Card className="flex flex-col h-[600px]">
        <CardHeader className="flex-shrink-0">
          <div className="flex flex-col space-y-4">
            <CardTitle className="flex items-center gap-2">
              <Bot className="h-5 w-5" />
              Agricultural AI Chat
            </CardTitle>
            
            {/* Controls */}
            <div className="flex flex-wrap items-center gap-4">
              {/* Language Selection */}
              <div className="flex items-center gap-2">
                <Globe className="h-4 w-4 text-muted-foreground" />
                <Select value={selectedLanguage} onValueChange={setSelectedLanguage}>
                  <SelectTrigger className="w-32">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {LANGUAGE_OPTIONS.map((option) => (
                      <SelectItem key={option.value} value={option.value}>
                        <div className="flex items-center gap-2">
                          <span>{option.flag}</span>
                          <span>{option.label}</span>
                        </div>
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              {/* Location Status */}
              <div className="flex items-center gap-2">
                <MapPin className="h-4 w-4 text-muted-foreground" />
                <div className="flex items-center gap-2">
                  <span className="text-sm text-muted-foreground">Location:</span>
                  {locationStatus === "loading" ? (
                    <Badge variant="secondary" className="text-xs">
                      <Loader2 className="w-3 h-3 animate-spin mr-1" />
                      Getting location...
                    </Badge>
                  ) : locationStatus === "success" ? (
                    <Badge variant="default" className="text-xs">
                      {location.name} ({location.latitude}, {location.longitude})
                    </Badge>
                  ) : (
                    <Badge variant="outline" className="text-xs">
                      Delhi (default)
                    </Badge>
                  )}
                  <Button
                    variant="ghost"
                    size="sm"
                    onClick={getCurrentLocation}
                    disabled={locationStatus === "loading"}
                    className="h-6 px-2 text-xs"
                  >
                    Refresh
                  </Button>
                </div>
              </div>
            </div>
          </div>
        </CardHeader>
        <CardContent className="flex-1 flex flex-col p-0 min-h-0">
          {/* Chat Messages Area */}
          <ScrollArea className="flex-1 p-4" ref={scrollAreaRef}>
            <div className="space-y-4">
              {/* Welcome Message */}
              <div className="flex items-start gap-3">
                <div className="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center">
                  <Bot className="h-4 w-4 text-primary" />
                </div>
                <div className="flex-1">
                  <div className="bg-muted/50 rounded-lg p-3 border">
                    <p className="text-sm">
                      Hello! I'm your agricultural AI assistant. I can help you with:
                    </p>
                    <ul className="text-sm mt-2 space-y-1 text-muted-foreground">
                      <li>тАв Crop recommendations based on your conditions</li>
                      <li>тАв Weather-based farming advice</li>
                      <li>тАв Soil health analysis and improvements</li>
                      <li>тАв Pest and disease management</li>
                      <li>тАв Irrigation and water management tips</li>
                    </ul>
                    <p className="text-sm mt-2">
                      Feel free to ask me anything about your farming needs! {speechSupported && getMultilingualMessages().voiceInstructions}
                    </p>
                  </div>
                </div>
              </div>

              {/* Chat Messages */}
              {messages.map((message) => (
                <div key={message.id} className="flex items-start gap-3">
                  <div className="w-8 h-8 rounded-full flex items-center justify-center">
                    {message.role === "user" ? (
                      <div className="w-8 h-8 rounded-full bg-accent/10 flex items-center justify-center">
                        <User className="h-4 w-4 text-accent" />
                      </div>
                    ) : (
                      <div className="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center">
                        <Bot className="h-4 w-4 text-primary" />
                      </div>
                    )}
                  </div>
                  <div className="flex-1">
                    <div 
                      className={`rounded-lg p-3 border ${
                        message.role === "user" 
                          ? "bg-accent/10 border-accent/20 ml-8" 
                          : "bg-muted/50 border-muted"
                      }`}
                    >
                      <p className="text-sm whitespace-pre-wrap">{message.content}</p>
                      <p className="text-xs text-muted-foreground mt-1">
                        {message.timestamp.toLocaleTimeString()}
                      </p>
                    </div>
                  </div>
                </div>
              ))}

              {/* Loading indicator */}
              {isLoading && (
                <div className="flex items-start gap-3">
                  <div className="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center">
                    <Bot className="h-4 w-4 text-primary" />
                  </div>
                  <div className="flex-1">
                    <div className="bg-muted/50 rounded-lg p-3 border">
                      <div className="flex items-center gap-2">
                        <Loader2 className="h-4 w-4 animate-spin" />
                        <p className="text-sm text-muted-foreground">AI is thinking...</p>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </ScrollArea>

          {/* Chat Input Area */}
          <div className="flex-shrink-0 border-t bg-background p-4">
            <div className="flex gap-2 mb-2">
              <Input 
                value={inputMessage}
                onChange={(e) => setInputMessage(e.target.value)}
                onKeyPress={handleKeyPress}
                placeholder={isListening ? getMultilingualMessages().listening : getMultilingualMessages().placeholder}
                className="flex-1 bg-background"
                disabled={isLoading || isListening}
              />
              {/* Speech-to-Text Button */}
              {speechSupported && (
                <Button
                  onClick={toggleSpeechRecognition}
                  size="icon"
                  variant={isListening ? "default" : "outline"}
                  disabled={isLoading}
                  className={`${isListening ? "bg-red-500 hover:bg-red-600 animate-pulse" : ""}`}
                  title={isListening ? getMultilingualMessages().stopListening : getMultilingualMessages().clickToSpeak}
                >
                  {isListening ? (
                    <MicOff className="h-4 w-4" />
                  ) : (
                    <Mic className="h-4 w-4" />
                  )}
                </Button>
              )}
              <Button 
                onClick={sendMessage}
                size="icon" 
                disabled={isLoading || !inputMessage.trim() || isListening}
                className={isLoading ? "bg-muted" : ""}
              >
                {isLoading ? (
                  <Loader2 className="h-4 w-4 animate-spin" />
                ) : (
                  <Send className="h-4 w-4" />
                )}
              </Button>
            </div>
            <div className="flex justify-between items-center text-xs text-muted-foreground">
              <div className="flex items-center gap-4">
                <span>{isListening ? getMultilingualMessages().listeningStatus : getMultilingualMessages().pressEnter}</span>
                <div className="flex items-center gap-1">
                  {apiStatus === "online" ? (
                    <><div className="w-2 h-2 bg-green-500 rounded-full"></div><span>{getMultilingualMessages().apiOnline}</span></>
                  ) : apiStatus === "offline" ? (
                    <><AlertCircle className="w-3 h-3 text-red-500" /><span>{getMultilingualMessages().apiOffline}</span></>
                  ) : (
                    <><div className="w-2 h-2 bg-yellow-500 rounded-full"></div><span>{getMultilingualMessages().checkingApi}</span></>
                  )}
                </div>
                {speechSupported && (
                  <div className="flex items-center gap-1">
                    <Mic className="w-3 h-3 text-green-600" />
                    <span>{getMultilingualMessages().voiceEnabledStatus}</span>
                  </div>
                )}
              </div>
              <span>Language: {LANGUAGE_OPTIONS.find(lang => lang.value === selectedLanguage)?.label}</span>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
};

export default ChatbotPage;